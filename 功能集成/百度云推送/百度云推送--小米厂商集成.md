

**参考文档：**

**[小米厂商接入文档](http://push.baidu.com/doc/guide/manufacturer)**

**[小米SDK下载地址](https://admin.xmpush.xiaomi.com/zh_CN/mipush/downpage?version=2020092201)**

**[小米常见问题汇总](https://dev.mi.com/console/doc/detail?pId=1292)**



------

[TOC]

------



#### **1.小米推送服务接入**

```java
// 1.1 配置项目，创建应用
	网址：https://dev.mi.com/console/appservice/push.html

// 1.2 开通push服务

// 1.3 APPID、APIKEY和APPSECRET
获取小米厂商应用的信息APPID、APIKEY和APPSECRET，将APPID、APIKEY和APPSECRET保存到百度云推送的应用配置中
    
// 1.4 添加SDK
    1.4.1 将SDK-->MiPush_SDK_Client_3_8_0.jar(最新版)，放入项目的libs目录下;

	1.4.2 build.gradle(app)中，添加：
	dependencies { 
		implementation files('libs/MiPush_SDK_Client_3_8_0.jar')   
	} 

 //1.5 AndroidManifest文件配置   
	<!-- 小米推送权限 -->
	<uses-permission android:name="android.permission.GET_TASKS" />        
    <permission
        android:name="${applicationId}.permission.MIPUSH_RECEIVE"
        android:protectionLevel="signature" />
    <uses-permission android:name="${applicationId}.permission.MIPUSH_RECEIVE" />
    <!-- 小米代理运行需要的权限 END -->
    
        
	<!-- 小米代理推送必需组件 -->
        <service
            android:name="com.xiaomi.push.service.XMPushService"
            android:enabled="true"
            android:process=":pushservice" />
        <!--注:此 service 必须在 3.0.1 版本以后(包括 3.0.1 版本)加入-->
        <service
            android:name="com.xiaomi.push.service.XMJobService"
            android:enabled="true"
            android:exported="false"
            android:permission="android.permission.BIND_JOB_SERVICE"
            android:process=":pushservice" />
        <service
            android:name="com.xiaomi.mipush.sdk.PushMessageHandler"
            android:enabled="true"
            android:exported="true" />
        <!--注:此 service 必须在 2.2.5 版本以后(包括 2.2.5 版本)加入-->
        <service
            android:name="com.xiaomi.mipush.sdk.MessageHandleService"
            android:enabled="true" />
        <receiver
            android:name="com.xiaomi.push.service.receivers.NetworkStatusReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="android.net.conn.CONNECTIVITY_CHANGE" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </receiver>
        <receiver
            android:name="com.xiaomi.push.service.receivers.PingReceiver"
            android:exported="false"
            android:process=":pushservice">
            <intent-filter>
                <action android:name="com.xiaomi.push.PING_TIMER" />
            </intent-filter>
        </receiver>
        <receiver android:name="com.baidu.android.pushservice.PushPatchMessageReceiver">
            <intent-filter>
                <action android:name="com.xiaomi.mipush.RECEIVE_MESSAGE" />
                <action android:name="com.xiaomi.mipush.MESSAGE_ARRIVED" />
                <action android:name="com.xiaomi.mipush.ERROR" />
            </intent-filter>
        </receiver>
        <!-- 小米代理推送必需组件 END -->
                    
		<!-- 在小米开放平台中心查询应用的API Key -->
        <meta-data
            android:name="XM_APP_ID"
            android:value="xiaomi${XM_APP_ID}" />
        <meta-data
            android:name="XM_APP_KEY"
            android:value="xiaomi${XM_APP_KEY}" />   
	
	// 1.6 signing.gradle文件      
		   'xiaomi.appid'     : "2882303761518684016",
		   'xiaomi.appkey'    : "5151868443016",   
	
 	// 1.7 build.gradle(app)文件     
			manifestPlaceholders = [
                //添加
                XM_APP_ID         : flavorData.'xiaomi.appid'
                XM_APP_KEY        : flavorData.'xiaomi.appkey'
        ]
                
	// 1.8 Utils工具类获取AndroidManifest的meta-data属性
		
    	public static String getXMMetaValue(Context context, String metaKey) {
        	Bundle metaData = null;
        	String apiKey = null;
        	String key = null;
        	if (context == null || metaKey == null) {
            	return null;
        	}
        	try {
            	ApplicationInfo ai = context.getPackageManager()
                    .getApplicationInfo(context.getPackageName(),
                            PackageManager.GET_META_DATA);
            	if (null != ai) {
                	metaData = ai.metaData;
            	}
            	if (null != metaData) {
                	key = metaData.getString(metaKey);
	                //apiKey = key != null ? key.substring(6) : null;
                	apiKey = key != null ? key.replace("xiaomi", "") : null;
            	}
        	} catch (NameNotFoundException e) {
	            RSLog.e(TAG, "error " + e.getMessage());
        	}
        	return apiKey;
    	}        

	// 1.9 MainActivity中对于小米手机使用对应厂商推送
		if (RomUtils.isHuawei()) {
			//华为厂商
			RSLog.d(TAG,"Baidu push opens Huawei manufacturers");
			PushManager.enableHuaweiProxy(MainActivity.this, true);
		} else if (RomUtils.isXiaomi()) {
			// 小米厂商,小米代理需要的小米appid和appkey,请到小米推送官网申请
			String xmAppId = Utils.getXMMetaValue(getApplicationContext(), "XM_APP_ID").trim();
			String xmAppKey = Utils.getXMMetaValue(getApplicationContext(), "XM_APP_KEY").trim();
			RSLog.d(TAG, "Baidu push-Xiaomi key info====>>> mAppId: " + xmAppId + " xmAppKey: " + xmAppKey);
			if (!TextUtils.isEmpty(xmAppId) && !TextUtils.isEmpty(xmAppKey)) {
				PushManager.enableXiaomiProxy(MainActivity.this, true, xmAppId, xmAppKey);
 			} else {
				RSLog.e(TAG, "Please check Baidu push-Xiaomi manufacturer push configuration！");
			}
		}
		PushManager.startWork(getApplicationContext(),
				PushConstants.LOGIN_TYPE_API_KEY,
				Utils.getMetaValue(getApplicationContext(), "BD_API_KEY"));	
```



#### **2.代码混淆**

```java
# 小米代理推送
-dontwarn com.xiaomi.**
-dontwarn org.apache.thrift.**
-keep class com.xiaomi.**{*; }
-keep class org.apache.thrift.**{*; }
```



#### **3.应用被杀掉之后，能否接收到小米推送？**

```java
官网解释：https://dev.mi.com/console/doc/detail?pId=1292

当我的应用被杀掉之后，还能否接收到小米推送服务的消息？
1) 如果是在MIUI系统中，使用通知栏类型的消息，是不需要应用出于启动状态就能接收并弹出通知栏的。使用透传消息，则需要应用驻留后台才能接收，由于MIUI的自启动管理限制，所以如果应用被杀，是收不到透传消息的。

2) 如果是在非MIUI系统中，是需要应用驻留后台才能接收消息的，因此如果应用被杀死并且不能后台自启动的话，是没有办法接收消息的。为了让app尽可能的驻留后台，小米推送服务SDK监听了网络变化等系统事件，并且有应用之间的互相唤醒，但这些措施并不能保证应用可以一直在后台驻留。

```



#### **4.百度推送--小米厂商接入测试**

```java
测试应用：dayzip   
包名：com.client.dayzip
app id : 2882303761518684016
app key: 5151868443016
AppSecret：wSbpUW5JMjndNtifQVZZPQ==


测试手机：小米5S
Android版本：8.0.0
MIUI版本：10.2.1.0
channelId: 3887325602281898784
    
测试手机：Redmi K20 Pro
Android版本：10
MIUI版本：11.0.8
channelId: 4409296371310600116    

    
目前达到的效果：
1.小米厂商集成后，在百度控制台发送普通通知，App可以收到（无论进程是否被杀掉）;
2.目前APP百度推送接收的是透传消息，由于小米推送的限制，手动在后台将app进程杀死之后，无法正常接收到百度推送
2.应用在前台接收推送的消息到达率和稳定性相对于之前有所提升
```

